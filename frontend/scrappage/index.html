<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scrappage Network</title>
    <link rel="stylesheet" href="./src/styles/style.css" />
    <link rel="stylesheet" href="./src/styles/index.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <style>
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .error-message {
        color: red;
        margin-top: 5px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <header class="header" id="header">
      <div class="logo-container">
        <img src="./images/logoUpdated.png" alt="Logo" />
        <h3>Revive Wheels</h3>
      </div>
      <nav>
          <ul class="nav-links">
              <li><a href="../index.html" id="tab-style">Home</a></li>
              <li><a href="../ev_coversion_ui.html" id="tab-style">EV Conversion</a></li>
              <li><a href="../market.html" id="tab-style">Buy or Sell</a></li>
              <li class="active"><a href="#" id="tab-style">Scrappage Network</a></li>
          </ul>            
      </nav>
      <div class="auth-buttons">
        <button>
          <a href="../signin.html" style="text-decoration: none; color: green;">Login</a>
        </button>
        <button style="background-color: green;">
          <a href="../signup.html" style="text-decoration: none; color: white;">SignUp</a>
        </button>
      </div>
    </header>

    <div
      class="form-container"
      style="
        margin: 20px auto;
        max-width: 900px;
        padding: 20px;
        border: 2px solid #ddd;
        border-radius: 10px;
      "
    >
      <form id="form-details">
        <div
          class="form-content"
          style="display: flex; justify-content: space-between; gap: 20px"
        >
          <!-- Left Section - User Details -->
          <div
            class="user-details"
            style="
              flex: 1;
              padding: 10px;
              border: 1px solid rgb(200, 200, 200);
              border-radius: 5px;
            "
          >
            <h1>User Details</h1>
            <label for="username">Name</label>
            <input
              id="username"
              type="text"
              placeholder="Enter Name"
              required
              style="width: 100%; padding: 8px"
            />
            <div id="name-error" class="error-message"></div>

            <label for="userphone">Phone Number</label>
            <input
              id="userphone"
              type="tel"
              placeholder="Enter Phone Number"
              required
              style="width: 100%; padding: 8px"
            />
            <div id="phone-error" class="error-message"></div>

            <label for="userAadhar">Aadhar Number</label>
            <input
              id="userAadhar"
              type="text"
              placeholder="Enter Aadhar Number"
              required
              style="width: 100%; padding: 8px"
            />
            <div id="aadhar-error" class="error-message"></div>
          </div>

          <!-- Right Section - Video -->
          <div
            class="video-section"
            style="
              flex: 1;
              display: flex;
              justify-content: center;
              align-items: center;
              border: 1px solid rgb(210, 210, 210);
              padding: 10px;
              border-radius: 5px;
            "
          >
            <video
              playsinline
              autoplay
              loop
              muted
              style="width: 100%; border-radius: 5px"
            >
              <source
                src="https://cdnl.iconscout.com/lottie/premium/thumb/application-form-animated-icon-download-in-lottie-json-gif-static-svg-file-formats--job-cv-resume-employment-fill-ui-pack-user-interface-icons-8609542.mp4"
                type="video/mp4"
              />
              Your browser does not support the video tag.
            </video>
          </div>
        </div>

        <!-- Vehicle Details -->
        <div
          style="
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgb(217, 215, 215);
            padding: 10px;
            border-radius: 5px;
          "
        >
          <h1>Vehicle Details</h1>
          <label for="vehicleNo">Vehicle No.</label>
          <input
            id="vehicleNo"
            type="text"
            placeholder="Enter Vehicle No."
            required
            style="width: 100%; padding: 8px"
          />
          <div id="vehicleNo-error" class="error-message"></div>

          <label for="vehicleRC">Vehicle RC</label>
          <input
            id="vehicleRC"
            type="file"
            style="width: 100%; padding: 8px"
            accept=".jpeg, .png,.jpg, .pdf"
          />

          <label for="vehicleModel">Vehicle Model</label>
          <input
            id="vehicleModel"
            type="text"
            placeholder="Enter Vehicle Model"
            required
            style="width: 100%; padding: 8px"
          />
          <div id="vehicleModel-error" class="error-message"></div>

          <label for="vehiclePhotos">Vehicle Photos</label>
          <input
            id="vehiclePhotos"
            type="file"
            style="width: 100%; padding: 8px"
            multiple
            accept=".jpeg, .png,.jpg,"
          />

          <label for="scrapApplication">Application Copy</label>
          <input
            id="scrapApplication"
            type="file"
            style="width: 100%; padding: 8px"
            accept=".jpeg, .png,.jpg, .pdf"
          />
        </div>

        <div style="display: flex; justify-content: center; margin-top: 15px">
          <button
            type="submit"
            id="submitButton"
            style="
              padding: 10px 20px;
              background: #007bff;
              color: white;
              border: none;
              border-radius: 5px;
            "
          >
            Submit the Form
          </button>
        </div>
        <div
          id="form-status"
          style="text-align: center; margin-top: 10px"
        ></div>
      </form>
    </div>

    <footer
      style="
        text-align: center;
        padding: 10px;
        background: #f1f1f1;
        margin-top: 20px;
      "
    >
      Â© 2023 Revive Wheels. All rights reserved.
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("form-details");
        const submitBtn = document.getElementById("submitButton");
        const statusDiv = document.getElementById("form-status");

        // Enable debugging mode
        const DEBUG_MODE = true;

        function logDebug(message) {
          if (DEBUG_MODE) {
            console.log("[DEBUG]", message);
          }
        }

        function showStatus(message, isError = false) {
          statusDiv.textContent = message;
          statusDiv.style.color = isError ? "red" : "green";
          logDebug(`Status: ${message}`);
        }

        function validatePhone(phone) {
          const isValid = /^\d{10}$/.test(phone);
          if (!isValid) {
            document.getElementById("phone-error").textContent =
              "Please enter a valid 10-digit phone number";
          }
          return isValid;
        }

        function validateAadhar(aadhar) {
          const isValid = /^\d{12}$/.test(aadhar);
          if (!isValid) {
            document.getElementById("aadhar-error").textContent =
              "Please enter a valid 12-digit Aadhar number";
          }
          return isValid;
        }

        // Validate all required fields
        function validateForm() {
          logDebug("Validating form...");
          const requiredFields = [
            {
              id: "username",
              errorId: "name-error",
              message: "Name is required",
            },
            {
              id: "vehicleNo",
              errorId: "vehicleNo-error",
              message: "Vehicle number is required",
            },
            {
              id: "vehicleModel",
              errorId: "vehicleModel-error",
              message: "Vehicle model is required",
            },
          ];

          let isValid = true;

          // Check required text fields
          requiredFields.forEach((field) => {
            const element = document.getElementById(field.id);
            const errorElement = document.getElementById(field.errorId);

            if (!element.value.trim()) {
              errorElement.textContent = field.message;
              element.style.borderColor = "red";
              isValid = false;
            } else {
              errorElement.textContent = "";
              element.style.borderColor = "";
            }
          });

          // Validate phone and Aadhar
          isValid =
            validatePhone(document.getElementById("userphone").value) &&
            isValid;
          isValid =
            validateAadhar(document.getElementById("userAadhar").value) &&
            isValid;

          return isValid;
        }

        // Form submission handler
        form.addEventListener("submit", async function (e) {
          e.preventDefault();
          logDebug("Form submission started");

          if (!validateForm()) {
            showStatus("Please fix the errors in the form", true);
            return;
          }

          try {
            // Prepare form data
            const formData = {
              userDetails: {
                name: document.getElementById("username").value,
                phone: document.getElementById("userphone").value,
                aadhar: document.getElementById("userAadhar").value,
              },
              vehicleDetails: {
                vehicleNo: document.getElementById("vehicleNo").value,
                vehicleModel: document.getElementById("vehicleModel").value,
                rcUploaded:
                  document.getElementById("vehicleRC").files.length > 0,
                photosUploaded:
                  document.getElementById("vehiclePhotos").files.length > 0,
                applicationUploaded:
                  document.getElementById("scrapApplication").files.length > 0,
              },
              submissionDate: new Date().toISOString(),
            };

            logDebug("Form data prepared:", formData);

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<span class="loading-spinner"></span> Submitting...';
            showStatus("Submitting your form...");

            // Replace with your actual JSONBin.io API key
            const apiKey =
              "$2a$10$n6VasSdOa65rGVrwT/IZZOUD6IkOANNpEPeVM9i9UdlctYBtQ3GH2";

            const response = await fetch("https://api.jsonbin.io/v3/b", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Master-Key": apiKey,
                "X-Bin-Name": "Scrappage Network Applications",
              },
              body: JSON.stringify(formData),
            });

            logDebug("API response status:", response.status);

            if (!response.ok) {
              const errorData = await response.json();
              logDebug("API error response:", errorData);
              throw new Error(
                errorData.message || `HTTP error! status: ${response.status}`
              );
            }

            const result = await response.json();
            logDebug("API success response:", result);

            showStatus("Form submitted successfully!");
            window.location.href = "./pickup.html"
            form.reset();
          } catch (error) {
            console.error("Submission error:", error);
            showStatus(`Error: ${error.message}`, true);

            // Additional error details for debugging
            if (error.message.includes("Failed to fetch")) {
              showStatus(
                "Network error - check your internet connection",
                true
              );
            } else if (
              error.message.includes("401") ||
              error.message.includes("403")
            ) {
              showStatus("Authentication error - please contact support", true);
            }
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = "Submit the Form";
          }
        });

        // Input formatting and validation
        document
          .getElementById("userphone")
          .addEventListener("input", function (e) {
            this.value = this.value.replace(/\D/g, "").slice(0, 10);
            validatePhone(this.value);
          });

        document
          .getElementById("userAadhar")
          .addEventListener("input", function (e) {
            this.value = this.value.replace(/\D/g, "").slice(0, 12);
            validateAadhar(this.value);
          });

        // Clear errors when typing in fields
        document
          .querySelectorAll("input, select, textarea")
          .forEach((element) => {
            element.addEventListener("input", function () {
              const errorElement = document.getElementById(`${this.id}-error`);
              if (errorElement) {
                errorElement.textContent = "";
                this.style.borderColor = "";
              }
            });
          });
      });
    </script>
  </body>
</html>
